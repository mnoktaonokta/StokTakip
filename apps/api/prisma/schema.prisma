generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  employee
}

enum WarehouseType {
  MAIN
  CUSTOMER
  EMPLOYEE
}

enum ActionType {
  STOCK_IN
  STOCK_OUT
  TRANSFER_OUT
  TRANSFER_IN
  TRANSFER_REVERSE
  INVOICE_CREATED
  INVOICE_CANCELLED
  CSV_IMPORT
  MANUAL_ADJUSTMENT
}

enum TransferStatus {
  PENDING
  COMPLETED
  REVERSED
}

model User {
  id        String    @id @default(cuid())
  name      String
  email     String    @unique
  role      UserRole  @default(employee)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  transfers Transfer[] @relation("TransferCreatedBy")
  logs      Log[]
  invoices  Invoice[]  @relation("InvoiceCreatedBy")
}

model Product {
  id            String   @id @default(cuid())
  referenceCode String   @unique
  name          String
  category      String?
  brand         String?
  isActive      Boolean  @default(true)
  criticalStockLevel Int?
  salePrice     Decimal? @db.Decimal(12, 2)
  purchasePrice Decimal? @db.Decimal(12, 2)
  vatRate       Decimal? @db.Decimal(5, 2) @default(10)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lots Lot[]
  logs Log[]
}

model Lot {
  id          String        @id @default(cuid())
  productId   String
  product     Product       @relation(fields: [productId], references: [id])
  lotNumber   String
  quantity    Int
  barcode     String?       @unique
  expiryDate  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  stockLocations StockLocation[]
  transfers      Transfer[]
  logs           Log[]

  @@unique([productId, lotNumber])
}

model Warehouse {
  id        String         @id @default(cuid())
  name      String
  type      WarehouseType  @default(MAIN)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  stockLocations StockLocation[]
  transfersFrom  Transfer[]    @relation("TransferFromWarehouse")
  transfersTo    Transfer[]    @relation("TransferToWarehouse")
  customers      Customer[]
  logs           Log[]
}

model Customer {
  id           String    @id @default(cuid())
  name         String
  email        String?
  phone        String?
  address      String?
  taxOffice    String?
  taxNumber    String?
  logo         String?
  warehouseId  String?   @unique
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  warehouse Warehouse? @relation(fields: [warehouseId], references: [id])
  invoices  Invoice[]
  logs      Log[]
  notes     CustomerNote[]
}

model CustomerNote {
  id         String   @id @default(cuid())
  customerId String
  content    String
  createdAt  DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model StockLocation {
  id           String    @id @default(cuid())
  warehouseId  String
  lotId        String
  quantity     Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  lot       Lot       @relation(fields: [lotId], references: [id])

  @@unique([warehouseId, lotId])
}

model Transfer {
  id               String         @id @default(cuid())
  fromWarehouseId  String
  toWarehouseId    String
  lotId            String
  quantity         Int
  createdByUserId  String
  barcodeScanned   Boolean        @default(false)
  status           TransferStatus @default(PENDING)
  notes            String?
  timestamp        DateTime       @default(now())

  fromWarehouse Warehouse @relation("TransferFromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse @relation("TransferToWarehouse", fields: [toWarehouseId], references: [id])
  lot           Lot       @relation(fields: [lotId], references: [id])
  createdBy     User      @relation("TransferCreatedBy", fields: [createdByUserId], references: [id])
  logs          Log[]
  invoices      Invoice[] @relation("InvoiceTransfers")
}

enum InvoiceDocumentType {
  PROFORMA
  IRSALIYE
  FATURA
}

model Invoice {
  id            String    @id @default(cuid())
  customerId    String
  items         Json
  transferIds   Json?
  invoiceNumber String?
  totalAmount   Decimal?  @db.Decimal(12, 2)
  timestamp     DateTime  @default(now())
  createdById   String?
  documentType  InvoiceDocumentType @default(FATURA)
  documentNo    String?
  issueDate     DateTime? @default(now())
  dueDate       DateTime?
  dispatchNo    String?
  dispatchDate  DateTime?
  notes         String?
  grossTotal    Decimal?  @db.Decimal(12, 2)
  discountTotal Decimal?  @db.Decimal(12, 2)
  netTotal      Decimal?  @db.Decimal(12, 2)
  taxTotal      Decimal?  @db.Decimal(12, 2)

  customer  Customer @relation(fields: [customerId], references: [id])
  createdBy User?    @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  logs      Log[]
  transfers Transfer[] @relation("InvoiceTransfers")
}

model Log {
  id          String      @id @default(cuid())
  userId      String?
  customerId  String?
  productId   String?
  lotId       String?
  transferId  String?
  invoiceId   String?
  warehouseId String?
  actionType  ActionType
  description String
  barcodeUsed Boolean     @default(false)
  timestamp   DateTime    @default(now())

  user      User?      @relation(fields: [userId], references: [id])
  customer  Customer?  @relation(fields: [customerId], references: [id])
  product   Product?   @relation(fields: [productId], references: [id])
  lot       Lot?       @relation(fields: [lotId], references: [id])
  transfer  Transfer?  @relation(fields: [transferId], references: [id])
  invoice   Invoice?   @relation(fields: [invoiceId], references: [id])
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id])
}
